# KKday 크롤링 시스템 - 상세 작업 목록

> 💡 **세션 시작 시**: README.md의 "🚀 기본 준비 단계"를 먼저 확인하여 현재 작업에 필요한 추가 문서들을 파악하세요.

## 🎯 Phase 1: 핵심 모듈 전환 (진행중)

### ✅ 완료된 작업
- [x] `./src/config.py` - Klook → KKday 기본 설정 변경 완료
- [x] `./src/utils/location_learning.py` - import 경로 `klook.src.config` → `kkday.src.config` 수정 완료
- [x] `./src/utils/city_manager.py` - 도시명 별칭 매핑 테이블 정리 및 "청도": "칭따오" 추가 완료
- [x] `./src/utils/file_handler.py` - 함수명, URL, 주석 KKday용으로 변경 완료 (CSS 셀렉터 보류)
- [x] `./src/scraper/crawler.py` - 클래스명 `KKdayCrawler`, 함수명 모든 KKday용 변경 완료
- [x] `./README.md` - 프로젝트 문서화 및 개발 가이드라인 작성 완료
- [x] `./PRD.md` - 제품 요구사항 명세서 작성 완료

### 🎉 2025-09-07 추가 완료 작업
- [x] `./src/scraper/url_manager.py` - **완전 KKday 전환 완료** ✨
  - [x] 함수명 변경: `is_valid_klook_url()` → `is_valid_kkday_url()`
  - [x] 함수명 변경: `normalize_klook_url()` → `normalize_kkday_url()`  
  - [x] 함수명 변경: `extract_activity_id()` → `extract_product_id()`
  - [x] URL 패턴: KLOOK → KKday 도메인 및 경로 패턴 완전 변경
  - [x] 페이지네이션: 화살표 방식 → 숫자 클릭 방식으로 완전 전환
  - [x] CSS 셀렉터: KKday 전용 셀렉터 매핑 완료
  - [x] USER_AGENT 설정: `get_random_user_agent()` 연동 완료
  - [x] 전체 코드 검증: KLOOK 잔여 코드 0개 확인
- [x] **방콕 크롤링 시스템 준비 완료** - 페이지네이션 문제 해결로 실행 가능 상태

### 🎉 2025-09-08 추가 완료 작업
- [x] **KKday 메인 목록 페이지 분석 및 구조 파악** ✨
  - [x] 검색창 셀렉터: `#search_experience_value` 
  - [x] 검색버튼 셀렉터: `.btn.btn-primary` 확인
  - [x] 상품카드 구조: `.product-card.gtm-prod-card-element` 매핑
  - [x] 페이지네이션: `.pagination .a-page a` 숫자 클릭 방식 검증
  - [x] URL 패턴: `/ko/product/productlist/{도시명}` 확인
- [x] **방콕 크롤링 URL 패턴 검증 및 테스트** ✨
  - [x] `url_manager.py`에 목록페이지 URL 패턴 추가
  - [x] `is_valid_kkday_url()` 함수에 `/ko/product/productlist/` 패턴 추가
  - [x] 방콕 URL 검증 테스트: `https://www.kkday.com/ko/product/productlist/%EB%B0%A9%EC%BD%95` → True
  - [x] URL 정규화 테스트: UTM 파라미터 제거, page 파라미터 유지 확인
- [x] **핵심 파일들 Klook 잔여 코드 분석** ✨
  - [x] `crawler.py`: Klook 잔여 코드 0개 확인 (완전 KKday 전환 상태)
  - [x] `ranking.py`: 도메인 독립적 설계로 수정 불필요 확인
  - [x] 노트북 파일들 분석: `kkday_crawler_new.ipynb`만 완전 전환 완료 확인
- [x] **이미지 디렉토리 구조 수정** ✨
  - [x] `file_handler.py`의 `ensure_directory_structure()` 함수 수정
  - [x] 잘못된 구조: `kkday_img/도시명/` → 올바른 구조: `kkday_img/대륙/국가/도시명/`
  - [x] 도시국가 예외처리: `kkday_img/아시아/싱가포르/` (도시 폴더 생략)
  - [x] 방콕 테스트: `kkday_img/아시아/태국/방콕/` 구조 생성 확인

### 🎉 2025-09-11 시스템 안정화 완료 작업 ✨
- [x] **크롤링 시스템 100% 안정화 달성** - 모든 핵심 오류 완전 해결
  - [x] Tuple unpacking 에러 해결 (`get_city_info` → `get_city_location` 함수 분리)
  - [x] 이미지 수집 기능 완전 복구 (KKday 실제 CSS 셀렉터로 교체)
  - [x] WSL 가상환경 구축 완료 (Pillow + Selenium + 필요 패키지 설치)
  - [x] 국가별 통합 CSV 자동 생성 기능 추가 (`auto_create_country_csv_after_crawling`)
  - [x] 랭킹 시스템 오류 완전 해결 (`mark_url_processed_fast`에 `product_id` 매개변수 추가)
  - [x] import 경로 오류 수정 (`location_learning.py`의 `from ...config import` 수정)
  - [x] **실제 크롤링 100% 성공 검증** (삿포로 2/2 상품 + 메인/썸네일 이미지 저장)

### 🎯 2025-09-12 URL 수집 순서 보장 시스템 구현 ✨
- [x] **URL 수집 순서 무작위화 문제 진단** - `set()` 사용으로 인한 1페이지+3페이지 혼재 현상 분석
- [x] **성능 최적화된 순서 보장 시스템 구현** - `list + set` 조합으로 O(1) 중복 체크 + 순서 유지
  - [x] `collect_urls_from_page()` 함수 수정: set → list+set 조합
  - [x] `get_pagination_urls()` 함수 수정: set → list+set 조합  
  - [x] `execute_comprehensive_url_collection()` 함수 수정: set → list+set 조합
- [x] **README.md에 성능 최적화 분석 지침 추가** - 확인된 데이터 기반 논리적 분석 원칙 수립

### 🎉 2025-09-13 스크롤 패턴 시스템 구현 완료 작업 ✨
- [x] **봇 탐지 회피를 위한 50개 인간 행동 기반 스크롤 패턴 시스템 구현** ⭐
  - [x] `./src/scraper/human_scroll_patterns.py` 파일 생성 완료
    - [x] **느린_탐색** (1-10): 꼼꼼한_독서형, 신중한_검토형, 상세_분석형 등
    - [x] **빠른_스캔** (11-20): 급한_훑어보기형, 키워드_탐색형, 개요_파악형 등  
    - [x] **상세_읽기** (21-30): 완벽주의형, 학습목적형, 전문가형 등
    - [x] **되돌아_보기** (31-40): 확인중독형, 비교검토형, 망설이는형 등
    - [x] **특이_행동** (41-50): 불규칙형, 충동형, 탐험형 등
  - [x] **실제 인간 행동 완벽 모방 설계**
    - [x] ActionChains + Keys 조합으로 자연스러운 스크롤 구현
    - [x] 각 패턴별 고유한 pause duration과 scroll pixels 설정
    - [x] 위아래 스크롤, 반복 확인, 망설임 등 실제 사용자 행동 패턴 재현
  - [x] **crawler.py 통합 완료**
    - [x] Line 19: `from . import human_scroll_patterns` 모듈 import
    - [x] Line 156-163: 상세 페이지에서 인간 스크롤 패턴 랜덤 실행
    - [x] 에러 처리로 스크롤 실패 시에도 크롤링 계속 진행 보장

### 🎉 2025-09-15 봇 회피 최적화 크롤러 v2.0 완성! ✨
- [x] **KKday 봇 회피 최적화 크롤러 v2.0 개발 완료** ⭐⭐⭐
  - [x] **세션 분리 시스템 구현** - 1단계(URL수집) ↔ 2단계(상세크롤링) 완전 분리
  - [x] **시간 간격 강제 대기** - 봇 탐지 회피를 위한 수동 시간 조절 시스템
  - [x] **50개 스크롤 패턴 통합** - 각 상품마다 다른 인간 행동 모방
  - [x] **통합 품질 평가 시스템** - 봇 회피(50%) + 데이터 품질(50%) = S~D급 등급제
  - [x] **완전한 실행 요약 및 문제 해결 가이드** - 기존 노트북 수준 완성도 달성
  - [x] **전체 시간 추적 시스템** - 1단계 시작부터 2단계 완료까지 완전 추적
  - [x] **디렉토리 구조 자동 확보** - `ensure_directory_structure()` 통합
  - [x] `kkday_bot_safe_crawler.ipynb` 파일 생성 완료

- [x] **실제 테스트 성공 완료** (2025-09-15 12:44)
  - [x] **치앙마이 1단계 테스트**: 2개 URL 수집 성공 ✅
  - [x] **봇 회피 시스템 검증**: 자연스러운 탐색 패턴 적용 ✅
  - [x] **스마트 필터링**: 목록 페이지 10개 제외, 상품 페이지만 선별 ✅
  - [x] **효율성 확인**: 1페이지에서 목표 달성하여 즉시 중단 ✅
  - [x] **파일 저장**: kkday_urls.txt 정상 생성 ✅

### 🔄 진행중인 작업
**우선순위 1: 치앙마이 2단계 테스트 대기 중** ⏰
- 1단계 완료 후 시간 간격 대기 중 (봇 회피 최적화)
- 권장 실행 시간: 2025-09-15 15:00-18:00 (2-5시간 후)

### ⏳ 대기중인 작업
**우선순위 1: 봇 회피 최적화 크롤러 v2.0 완전 검증** ⭐
  - [ ] **치앙마이 2단계 실행** (시간 간격 후 실행)
    - [ ] 50개 스크롤 패턴 실제 적용 확인
    - [ ] 상세 정보 크롤링 성공률 검증
    - [ ] 통합 CSV 생성 및 이미지 다운로드 확인
    - [ ] 통합 품질 평가 시스템 등급 확인 (S~D급)
    - [ ] 전체 봇 탐지 회피율 95-98% 달성 검증

**우선순위 2: 추가 도시 테스트** ⭐
  - [ ] 다른 도시로 확장 테스트 (방콕, 도쿄 등)
  - [ ] 시간 간격을 두고 순차 테스트
  - [ ] 봇 회피 성능 지속성 검증
    
    **🎯 수정한 내용:**
    - `collect_urls_from_page()` (Line 135-157): `set()` → `list + set` 조합으로 한 페이지 내 순서 보장
    - `get_pagination_urls()` (Line 167-196): `set()` → `list + set` 조합으로 페이지네이션 순서 보장 
    - `execute_comprehensive_url_collection()` (Line 454-459): `list(set())` → 수동 중복 제거로 최종 순서 보장
    
    **🔍 테스트할 내용:**
    - **문제:** 기존에는 삿포로 TARGET_PRODUCTS=2 설정 시 **1페이지 1개 + 3페이지 1개** 무작위 선택
    - **목표:** 수정 후 **1페이지 상위 2개 상품**이 순서대로 정확히 선택되는지 검증
    - **방법:** 삿포로, TARGET_PRODUCTS=2, MAX_PAGES=3 설정으로 크롤링 실행하여 순서 확인

**우선순위 2: 시스템 검증 및 테스트** ⭐
  - [ ] **KKday 메인 목록 페이지 분석** - https://www.kkday.com/ko/product/productlist
    - [ ] 전체 상품 목록 구조 분석
    - [ ] 페이지네이션 실제 동작 방식 확인
    - [ ] 필터링 및 정렬 옵션 분석
    - [ ] 상품 카드 셀렉터 정확성 검증
  - [ ] **방콕 실제 크롤링 테스트** - url_manager.py 수정 효과 검증
  - [ ] 페이지네이션 동작 확인 (숫자 클릭 방식)
  - [ ] URL 수집 및 데이터 추출 정확성 검증

**우선순위 2: 남은 핵심 모듈 전환** (검증 후 실행)
  - [ ] `./src/scraper/driver_manager.py` - KKday 웹사이트 대응 작업
    - [ ] 라인 136-138: 주석 및 URL `https://www.klook.com` → `https://www.kkday.com` 변경
    - [ ] 라인 156-161: 검색창 CSS 셀렉터 KKday용으로 변경
    - [ ] 라인 198-202: 검색 버튼 CSS 셀렉터 KKday용으로 변경

  - [ ] `./src/scraper/parsers.py` - 데이터 파싱 로직 KKday 대응
    - [ ] Klook 관련 함수명/클래스명 → KKday로 변경
    - [ ] 상품 정보 추출 CSS 셀렉터 KKday용으로 전면 교체
    - [ ] 가격, 평점, 리뷰수 등 모든 데이터 필드 셀렉터 업데이트

  - [x] `./src/scraper/ranking.py` - **순위 시스템 완전 개선 완료** ✨
    - [x] 모든 상품 rank=1 문제 해결 → 순차적 순위 부여 (1,2,3...)
    - [x] 목록페이지 URL 포함 문제 해결 → 상품 상세페이지만 필터링
    - [x] 글로벌 rank_mapping.json → 도시별 분리 저장 (SEL_, BKK_ 등)
    - [x] 순위 연속성 보장 → 마지막 순위+1부터 자동 시작
    - [x] 코드 단순화 → 347줄에서 135줄로 대폭 축소
    - [x] 통합 테스트 4/4 모두 통과 확인

  - [x] `./src/scraper/crawler.py` - **순위 시스템 통합 완료** ✨
    - [x] URL 필터링 로직 추가 → filter_product_detail_urls() 함수
    - [x] 순위 시스템 연동 → get_next_available_rank() 함수
    - [x] 불필요한 wrapper 함수 제거 → 코드 최적화

  - [ ] KKday 하이라이트 수집 함수 구현 (다중 셀렉터 방식)
  - [ ]KKday 투어형태 수집 함수 구현 (정보테이블 + 옵션명 + 상품명)
  - [ ]KKday 언어/소요시간 아이콘 기반 수집 로직 구현
  - [ ]KKday 카테고리 breadcrumb 수집 로직 구현
  - [ ]crawler.py 메인 로직 KKday용 수정
  - [ ]driver_manager.py의 검색/네비게이션 로직 수정
  - [ ]테스트 및 디버깅
  - [ ]README.md 업데이트

### 🔧 CSS 셀렉터 수집 대기 목록
**우선순위 1: 기본 검색 기능**
- [ ] KKday 메인 페이지 검색창 셀렉터
- [ ] KKday 검색 버튼 셀렉터  
- [ ] KKday 검색 결과 페이지 상품 링크 셀렉터

**우선순위 2: 상품 데이터 추출**
- [ ] 상품명 추출 셀렉터
- [ ] 가격 정보 셀렉터  
- [ ] 평점 셀렉터
- [ ] 리뷰수 셀렉터
- [ ] 카테고리/태그 셀렉터

**우선순위 3: 이미지 및 부가 정보**  
- [ ] 메인 이미지 URL 셀렉터
- [ ] 썸네일 이미지 URL 셀렉터
- [ ] 상품 설명/하이라이트 셀렉터
- [ ] 언어/투어형태 등 부가 정보 셀렉터

## 🎯 Phase 2: Jupyter 노트북 업데이트

### 📓 노트북 파일 전환 작업
- [ ] `./kkday_crawler.ipynb` - 메인 크롤러 노트북
  - [ ] Klook 관련 코드 → KKday로 일괄 변경
  - [ ] import 구문에서 `KlookCrawler` → `KKdayCrawler` 변경
  - [ ] 실행 예제 도시명 및 URL KKday용으로 수정
  - [ ] 출력 메시지 및 로그 KKday로 변경

- [ ] `./kkday_Sitemap_Collector.ipynb` - 사이트맵 URL 수집기
  - [ ] 사이트맵 URL `klook.com/sitemap.xml` → `kkday.com/sitemap.xml` 변경
  - [ ] URL 패턴 매칭 규칙 KKday 형식으로 수정
  - [ ] 수집된 URL 저장 경로 `klook_urls.csv` → `kkday_urls.csv` 변경

- [ ] `./kkday_Sitemap_Crawler.ipynb` - 사이트맵 기반 크롤러
  - [ ] 사이트맵 파싱 로직 KKday 구조 대응
  - [ ] 크롤링 대상 URL 필터링 KKday 패턴으로 수정  
  - [ ] 데이터 저장 구조 KKday 형식으로 통일

- [ ] `./kkday_ad_link generator.ipynb` - 제휴링크 생성기
  - [ ] 제휴링크 URL 패턴 `klook.com` → `kkday.com` 변경
  - [ ] 제휴 파트너 코드 KKday용으로 교체
  - [ ] 링크 생성 규칙 KKday API 스펙에 맞게 수정

## 🎯 Phase 3: 통합 테스트 및 검증

### 🧪 시스템 테스트
- [ ] **단위 테스트**: 각 모듈별 개별 기능 검증
  - [ ] `test_config.py` - 도시 정보 및 설정 테스트
  - [ ] `test_crawler.py` - 크롤링 엔진 테스트  
  - [ ] `test_parsers.py` - 데이터 파싱 정확성 테스트
  - [ ] `test_file_handler.py` - CSV/이미지 저장 테스트

- [ ] **통합 테스트**: 전체 시스템 연동 검증
  - [ ] 서울 3개 상품 크롤링 테스트 (성공률 100%)
  - [ ] 도쿄 5개 상품 크롤링 테스트 (성공률 95% 이상)
  - [ ] 방콕 10개 상품 크롤링 테스트 (이미지 다운로드 포함)
  - [ ] 파리 20개 상품 크롤링 테스트 (대용량 데이터 처리)

### 📊 성능 검증
- [ ] **속도 테스트**: 페이지당 처리시간 5초 이내 달성
- [ ] **메모리 테스트**: 100개 상품 크롤링 시 2GB 이내 사용
- [ ] **안정성 테스트**: 6시간 연속 실행 안정성 검증  
- [ ] **오류 복구 테스트**: 네트워크 오류 시 자동 재시도 검증

### 🔍 품질 검증  
- [ ] **데이터 품질**: 필수 필드 추출률 95% 이상 달성
- [ ] **이미지 품질**: 이미지 다운로드 성공률 90% 이상 달성
- [ ] **CSV 검증**: 데이터 형식 및 구조 일관성 검증
- [ ] **중복 제거**: 해시 기반 중복 상품 처리 정확성 검증

## 📋 작업 진행 규칙 (Chain of Thought 기법 적용)

### 🔄 고도화된 워크플로우
1. **작업 선택**: TODO 리스트에서 하나씩 순차 선택
2. **문제 분석**: 해결해야 할 핵심 문제 정의 (현재 상황 → 목표 상황)
3. **계획 수립**: 1단계→2단계→3단계 구체적 실행 계획 제시
4. **가정 사항**: 기존 코드 동작, 의존성, 제약사항 명시
5. **컨텍스트 제공**: 관련 파일의 핵심 코드 스니펫 포함
6. **사용자 승인**: 계획 검토 후 승인/수정 요청
7. **코드 적용**: 승인된 계획에 따라 실제 구현
8. **자가 검증**: CODING_STANDARDS.md의 체크리스트 적용
9. **통합 테스트**: 관련 모듈과의 연동 확인
10. **완료 표시**: 체크리스트 ✅ 표시 및 다음 작업 이동

### 📋 작업 계획서 템플릿
```markdown
## 작업 계획서: [파일명]
**문제**: [현재 상황과 해결해야 할 문제]
**목표**: [달성하려는 최종 상태]
**단계**: 
1. [1단계 작업 내용]
2. [2단계 작업 내용] 
3. [3단계 작업 내용]
**가정**: [작업 시 전제 조건들]
**의존성**: [관련된 다른 파일/함수]
**검증**: [완료 후 확인 방법]
```

### ✅ 완료 기준
- [ ] **코드 정확성**: Klook 관련 키워드 0개 남김 (`grep -i klook` 결과 없음)
- [ ] **동작 검증**: 수정된 함수/클래스 정상 import 및 실행
- [ ] **데이터 일관성**: 기존 데이터 구조 및 형식 유지
- [ ] **문서 동기화**: 주석 및 docstring KKday로 통일

### 🚨 주의사항  
- **CSS 셀렉터**: 실제 KKday 웹사이트 검증 후 적용
- **기능 호환성**: 기존 크롤링 기능 100% 유지
- **데이터 백업**: 수정 전 중요 파일 백업
- **테스트 우선**: 주요 변경 시 즉시 테스트 실행

## 📊 진행 현황 대시보드

### 전체 진행률 (2025-09-11 업데이트)
- **Phase 1**: 🎉 **100% 완료** (11/11 작업) - 크롤링 시스템 완전 안정화로 최종 완성 ✨
- **Phase 2**: 0% 완료 (0/4 작업)  
- **Phase 3**: 0% 완료 (0/12 작업)
- **전체**: 🚀 **42% 완료** (11/26 작업)

### 🎯 다음 작업 일정 (논리적 순서로 재정리)

**🥇 1단계: 검증 우선 (먼저 실행)**
1. 🔥 **KKday 메인 목록 페이지 분석** - https://www.kkday.com/ko/product/productlist 구조 분석
2. 🔥 **방콕 크롤링 실제 테스트** - url_manager.py 수정 효과 즉시 검증

**🥈 2단계: 개발 (검증 결과 반영)**  
3. 🔥 **driver_manager.py 완료** - 기본 웹사이트 접근 기능 완성  
4. 🔥 **parsers.py 완료** - 핵심 데이터 추출 기능 완성
5. ✅ **ranking.py 완료** - **순위 시스템 완전 개선 완료!**

**🥉 3단계: 통합 (최종 검증)**
6. 🧪 **통합 테스트** - 전체 시스템 검증

### 🏆 최근 성과 (2025-09-10)
- 🎉 **순위 시스템 완전 개선** - 모든 핵심 문제 해결 완료
  - ✅ 모든 상품 rank=1 문제 → 순차적 순위 부여 (1,2,3...)
  - ✅ 목록페이지 URL 포함 → 상품 상세페이지만 필터링  
  - ✅ 글로벌 파일 → 도시별 분리 저장 (SEL_, BKK_ 등)
  - ✅ 순위 연속성 보장 → 마지막 순위+1부터 자동 시작
  - ✅ 코드 최적화 → ranking.py 347줄→135줄, crawler.py 346줄→332줄
  - ✅ 통합 테스트 4/4 모두 통과 확인
- 📈 **Phase 1 진행률 10% 향상** (85% → 95%)

---

**문서 버전**: v1.3  
**최종 업데이트**: 2025-09-11 (크롤링 시스템 100% 안정화 완료)
**담당자**: mikael
