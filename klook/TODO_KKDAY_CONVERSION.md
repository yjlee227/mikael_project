# Klook → KKday 2단계 분리 실행 전환: TODO 리스트

## 🎯 프로젝트 목표
Klook 크롤러를 KKday의 2단계 분리 실행 방식으로 전환하여 봇 탐지 회피 능력 극대화 및 시스템 안정성 향상

---

## Phase 1: 아키텍처 준비 및 클래스 설계

### 1.1 새로운 클래스 파일 생성
- [ ] **`src/scraper/url_collector.py` 생성**
  - [ ] `KlookURLCollector` 클래스 정의
  - [ ] 기존 `collect_activity_urls()` 함수 통합
  - [ ] URL 저장 전용 로직 구현
  - [ ] 진행 상태 추적 기능 추가

- [ ] **`src/scraper/detail_crawler.py` 생성**
  - [ ] `KlookDetailCrawler` 클래스 정의
  - [ ] 기존 `extract_product_details()` 함수 통합
  - [ ] 저장된 URL 로드 기능 구현
  - [ ] 배치 처리 로직 추가

### 1.2 공통 유틸리티 확장
- [ ] **`src/utils/data_persistence.py` 생성**
  - [ ] URL 저장/로드 함수 구현
  - [ ] JSON 포맷 데이터 관리
  - [ ] 진행 상태 추적 시스템
  - [ ] 데이터 무결성 검증

- [ ] **`src/utils/session_manager.py` 생성**
  - [ ] 세션 상태 관리
  - [ ] 단계별 실행 제어
  - [ ] 오류 복구 메커니즘
  - [ ] 재시작 지원 로직

---

## Phase 2: 기존 함수 분석 및 재분배

### 2.1 현재 함수 매핑 분석
- [ ] **드라이버 관련 함수들**
  - [ ] `setup_driver()` → Stage 1 & Stage 2 모두 활용
  - [ ] `close_driver()` → 각 단계 종료 시 활용
  - [ ] `restart_driver()` → 오류 복구 시 활용

- [ ] **네비게이션 함수들**
  - [ ] `navigate_to_search()` → Stage 1에서만 활용
  - [ ] `handle_popup()` → Stage 1에서만 활용
  - [ ] `apply_filters()` → Stage 1에서만 활용

- [ ] **URL 수집 함수들**
  - [ ] `collect_activity_urls()` → Stage 1 핵심 기능으로 이관
  - [ ] `scroll_and_load_more()` → Stage 1에서만 활용
  - [ ] `extract_urls_from_page()` → Stage 1에서만 활용

### 2.2 데이터 추출 함수들
- [ ] **상세 정보 추출**
  - [ ] `extract_product_details()` → Stage 2 핵심 기능으로 이관
  - [ ] `get_product_name()` → Stage 2에서만 활용
  - [ ] `get_price()` → Stage 2에서만 활용
  - [ ] `get_rating()` → Stage 2에서만 활용
  - [ ] `get_description()` → Stage 2에서만 활용

- [ ] **미디어 처리**
  - [ ] `download_images()` → Stage 2에서만 활용
  - [ ] `process_thumbnails()` → Stage 2에서만 활용

### 2.3 공통 유틸리티 함수들
- [ ] **모든 단계에서 활용**
  - [ ] `human_scroll_patterns.py` 모든 스크롤 패턴 → Stage 1 & Stage 2
  - [ ] `city_manager.py` 도시 정보 관리 → Stage 1 & Stage 2
  - [ ] `file_handler.py` 파일 처리 → Stage 1 & Stage 2
  - [ ] Hash 중복 체크 → Stage 1 & Stage 2

---

## Phase 3: Stage 1 (URL 수집) 구현

### 3.1 KlookURLCollector 클래스 구현
- [ ] **초기화 및 설정**
  - [ ] `__init__(self, city_name: str)` 구현
  - [ ] 도시별 설정 로드
  - [ ] 드라이버 초기화 준비

- [ ] **URL 수집 메인 로직**
  - [ ] `collect_urls(self, max_urls: int)` 메서드 구현
  - [ ] 기존 `collect_activity_urls()` 로직 통합
  - [ ] 진행률 표시 기능 추가
  - [ ] 실시간 URL 검증

### 3.2 데이터 저장 시스템
- [ ] **URL 저장 포맷 정의**
  - [ ] JSON 스키마 설계
  - [ ] 메타데이터 포함 (수집 시간, 도시, 총 개수)
  - [ ] 중복 URL 자동 제거

- [ ] **저장 및 검증**
  - [ ] `save_collected_urls()` 메서드 구현
  - [ ] 파일 저장 경로 관리
  - [ ] 데이터 무결성 검증

### 3.3 실행 노트북 생성
- [ ] **`klook_stage1_runner.ipynb` 생성**
  - [ ] 간단한 설정 셀 (도시, 최대 URL 수)
  - [ ] URL 수집 실행 셀
  - [ ] 결과 확인 및 다음 단계 안내 셀

---

## Phase 4: Stage 2 (상세 크롤링) 구현

### 4.1 KlookDetailCrawler 클래스 구현
- [ ] **초기화 및 URL 로드**
  - [ ] `__init__(self, city_name: str)` 구현
  - [ ] `load_saved_urls()` 메서드 구현
  - [ ] 진행 상태 복원 기능

- [ ] **상세 크롤링 메인 로직**
  - [ ] `crawl_details_from_saved_urls()` 메서드 구현
  - [ ] 기존 `extract_product_details()` 로직 통합
  - [ ] 배치 처리 (URL 그룹별)
  - [ ] 오류 URL 재시도 로직

### 4.2 데이터 처리 강화
- [ ] **멀티미디어 처리**
  - [ ] 이미지 다운로드 통합
  - [ ] 썸네일 처리 로직
  - [ ] 파일 저장 검증

- [ ] **CSV 출력 표준화**
  - [ ] KKday 컬럼 스키마 적용
  - [ ] 데이터 형식 통일
  - [ ] 품질 검증 로직

### 4.3 실행 노트북 생성
- [ ] **`klook_stage2_runner.ipynb` 생성**
  - [ ] 저장된 URL 확인 셀
  - [ ] 상세 크롤링 실행 셀
  - [ ] 결과 통계 및 검증 셀

---

## Phase 5: 시스템 통합 및 안정성 강화

### 5.1 오류 처리 및 복구
- [ ] **재시작 메커니즘**
  - [ ] 진행 지점 저장 시스템
  - [ ] 부분 완료 상태에서 재개
  - [ ] 실패 URL 격리 및 재시도

- [ ] **로그 시스템**
  - [ ] 단계별 실행 로그
  - [ ] 오류 상세 기록
  - [ ] 성능 모니터링

### 5.2 설정 관리 업데이트
- [ ] **`src/config.py` 수정**
  - [ ] 2단계 실행 관련 설정 추가
  - [ ] 파일 경로 관리
  - [ ] 타이밍 설정 (권장 대기시간)

- [ ] **환경별 설정**
  - [ ] 개발/운영 환경 분리
  - [ ] 도시별 커스텀 설정
  - [ ] 사용자 설정 오버라이드

---

## Phase 6: 테스트 및 검증

### 6.1 단위 테스트
- [ ] **Stage 1 테스트**
  - [ ] 소규모 URL 수집 테스트 (10개)
  - [ ] 중간 규모 테스트 (50개)
  - [ ] 대규모 테스트 (200개)

- [ ] **Stage 2 테스트**
  - [ ] 저장된 URL 로드 테스트
  - [ ] 상세 정보 추출 테스트
  - [ ] 이미지 다운로드 테스트

### 6.2 통합 테스트
- [ ] **전체 워크플로우 테스트**
  - [ ] Stage 1 → Stage 2 연속 실행
  - [ ] 시간차 실행 테스트
  - [ ] 여러 도시 동시 처리

- [ ] **오류 시나리오 테스트**
  - [ ] 네트워크 오류 복구
  - [ ] 드라이버 크래시 복구
  - [ ] 부분 완료 상태 재시작

### 6.3 성능 검증
- [ ] **메모리 사용량 모니터링**
  - [ ] 각 단계별 메모리 사용량 측정
  - [ ] 메모리 누수 검사
  - [ ] 가비지 컬렉션 효율성

- [ ] **실행 시간 분석**
  - [ ] 단계별 실행 시간 측정
  - [ ] 병목 지점 분석
  - [ ] 최적화 포인트 식별

---

## Phase 7: 문서화 및 배포

### 7.1 사용자 가이드 작성
- [ ] **실행 가이드**
  - [ ] 단계별 실행 방법
  - [ ] 설정 변경 가이드
  - [ ] 문제 해결 가이드

- [ ] **마이그레이션 가이드**
  - [ ] 기존 사용자 대상 전환 가이드
  - [ ] 설정 마이그레이션 방법
  - [ ] 데이터 백업 및 복원

### 7.2 코드 품질 보증
- [ ] **코드 리뷰**
  - [ ] 모든 새 클래스 및 함수 검토
  - [ ] 기존 함수 통합 검증
  - [ ] 코딩 스타일 통일

- [ ] **최종 검증**
  - [ ] 모든 기존 함수 100% 활용 확인
  - [ ] CSV 컬럼 스키마 KKday 규격 준수 확인
  - [ ] 봇 탐지 회피 성능 검증

---

## 🚀 핵심 성공 기준

### 필수 달성 목표
- ✅ **기존 함수 100% 보존**: 모든 함수가 누락 없이 새 아키텍처에 통합
- ✅ **2단계 분리 실행**: URL 수집과 상세 크롤링의 완전한 세션 분리
- ✅ **시간차 실행**: 단계별 시간 간격을 통한 봇 탐지 회피 강화
- ✅ **CSV 규격 통일**: KKday와 100% 동일한 컬럼 스키마 적용
- ✅ **안정성 향상**: 메모리 누수 없는 안정적인 장시간 실행

### 성능 목표
- 🎯 URL 수집 성공률: 95% 이상
- 🎯 상세 크롤링 성공률: 90% 이상
- 🎯 봇 탐지 회피: 연속 실행 시 차단율 5% 이하
- 🎯 메모리 효율성: 각 단계 완료 후 메모리 완전 해제
- 🎯 재시작 성공률: 99% (오류 발생 시 자동 복구)

---

## 📋 체크리스트 요약

### Phase 1-2: 설계 및 분석 (예상 소요: 1-2일)
- [ ] 클래스 설계 완료
- [ ] 기존 함수 매핑 완료
- [ ] 아키텍처 검증 완료

### Phase 3-4: 구현 (예상 소요: 3-4일)
- [ ] Stage 1 구현 완료
- [ ] Stage 2 구현 완료
- [ ] 실행 노트북 완료

### Phase 5-6: 통합 및 테스트 (예상 소요: 2-3일)
- [ ] 시스템 통합 완료
- [ ] 모든 테스트 통과
- [ ] 성능 검증 완료

### Phase 7: 마무리 (예상 소요: 1일)
- [ ] 문서화 완료
- [ ] 최종 검증 완료
- [ ] 배포 준비 완료

---

*이 TODO 리스트는 Klook → KKday 2단계 분리 실행 전환 프로젝트의 상세 실행 계획입니다. (최종 업데이트: 2025-09-19)*

## 📈 진행 상태 추적

### 완료된 항목: 0 / 총 60개 항목
### 현재 진행률: 0%
### 다음 우선순위: Phase 1.1 새로운 클래스 파일 생성